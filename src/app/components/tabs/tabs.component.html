<div class="tabs-wrapper space-y-4">

  <!-- ---------- TAB HEADERS ---------- -->
  <div class="tabs-header flex flex-wrap items-center gap-2">
    <div
      class="tab-pill flex items-center gap-2"
      *ngFor="let tab of tabsField.tabs; let t = index"
      [class.active]="tabsField.activeTabIndex === t"
    >
      <button type="button" class="tab-pill__btn" (click)="onSetActiveTab(t)">
        {{ tab.title }}
      </button>

      <input
        *ngIf="tabsField.activeTabIndex === t"
        class="tab-pill__input form-input"
        [value]="tab.title"
        (click)="$event.stopPropagation()"
        (input)="onUpdateTabTitle(t, $any($event.target).value)"
      />

      <button
        type="button"
        class="btn btn-outline-danger btn-xxs"
        (click)="onDeleteTab(t)"
        [disabled]="tabsField.tabs.length === 1"
      >
        Ã—
      </button>
    </div>

    <button class="btn btn-outline-primary btn-xs" type="button" (click)="onAddTab()">
      + Add Tab
    </button>
  </div>

  <!-- ---------- TAB CONTENT ---------- -->
  <ng-container *ngFor="let tab of tabsField.tabs; let t = index">
    <div
      [hidden]="tabsField.activeTabIndex !== t"
      class="tab-dropzone border border-defaultborder rounded p-3 bg-bodybg2 dark:bg-bodybg"
      cdkDropList
      [id]="getTabListId(tab)"
      [cdkDropListData]="tab.fields"
      [cdkDropListConnectedTo]="connectedTargetsFor(getTabListId(tab))"
      (cdkDropListDropped)="onDropOnTab(t, $event)"
      [cdkDropListEnterPredicate]="tabEnterPredicate"
    >

      <!-- Empty state -->
      <div
        *ngIf="!tab.fields.length"
        class="text-xs italic text-mutedtextcolor py-4 text-center"
      >
        Drop fields for {{ tab.title }} here
      </div>

      <!-- Add Spreadsheet Button -->
      <div class="flex justify-center mb-2">
        <button
          type="button"
          class="btn btn-outline-primary btn-xs"
          (click)="onAddSpreadsheet(t)"
          title="Add Spreadsheet"
        >
          ðŸ“Š Add Spreadsheet
        </button>
      </div>

      <!-- Render inner fields -->
      <div
        *ngFor="let innerField of tab.fields; let innerIndex = index"
        class="tab-inner-field border border-defaultborder rounded-md p-2 mb-2 bg-white dark:bg-bodybg shadow-sm"
        cdkDrag
      >

        <!-- Toolbar -->
        <div class="inner-field-toolbar flex items-center justify-between mb-2">
          <span class="text-[11px] uppercase tracking-wide text-defaulttextcolor">
            {{ innerField.label }}
          </span>

          <button
            type="button"
            class="text-xs text-white bg-red-500 hover:bg-red-600 rounded-full w-5 h-5 flex items-center justify-center"
            (click)="onDeleteNestedField(t, innerIndex)"
          >
            &times;
          </button>
        </div>

        <!-- ---------- FIELD TYPES ---------- -->
        <ng-container [ngSwitch]="innerField.type">

          <!-- TEXT FIELD -->
          <ng-container *ngSwitchCase="'text'">
            <div class="flex items-center gap-3">
              <input [(ngModel)]="innerField.label" type="text" class="form-input w-40" placeholder="Label" />
              <input [(ngModel)]="innerField.value" type="text" class="form-input flex-1" placeholder="Enter text" />
              <input [(ngModel)]="innerField.key" type="text" class="form-input w-48" placeholder="Key" />
            </div>
          </ng-container>

          <!-- DROPDOWN -->
          <ng-container *ngSwitchCase="'dropdown'">
            <div class="flex items-center gap-3">
              <input [(ngModel)]="innerField.label" type="text" class="form-input w-40" placeholder="Label" />
              <select [(ngModel)]="innerField.value" class="form-select flex-1">
                <option *ngFor="let opt of (innerField.options || [])" [ngValue]="opt">{{ opt }}</option>
              </select>
            </div>
          </ng-container>

          <!-- CHECKBOX -->
          <ng-container *ngSwitchCase="'checkbox'">
            <div class="flex items-center gap-3">
              <input [(ngModel)]="innerField.label" type="text" class="form-input w-40" placeholder="Label" />
              <label class="inline-flex items-center gap-2">
                <input [(ngModel)]="innerField.value" type="checkbox" class="form-checkbox" />
                <span class="text-sm text-defaulttextcolor">Checked</span>
              </label>
            </div>
          </ng-container>

          <!-- SPREADSHEET -->
          <app-handsontable
            *ngSwitchCase="'handsontable'"
            [hotId]="innerField.id"
            [saveVersion]="saveVersion"
            (submitPayload)="onSpreadsheetSubmit(t, innerField.id, $event)"
          ></app-handsontable>

          <!-- COLUMNS -->
          <app-columns
            *ngSwitchCase="'columns'"
            [columnsField]="innerField"
            [fieldIndex]="fieldIndex"
            [connectedTargets]="connectedTargets"
            (dropOnColumn)="onNestedColumnsDrop(innerField, $event)"
            (deleteColumnField)="onNestedColumnsDelete(innerField, $event)"
            (addSpreadsheet)="onNestedColumnsAddSheet(innerField, $event)"
          ></app-columns>

        </ng-container>
      </div>
    </div>
  </ng-container>

</div>
